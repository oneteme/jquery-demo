package io.github.oneteme.jquery.demo.controller;

import java.util.HashMap;
import java.util.Map;

import javax.sql.DataSource;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.usf.jquery.core.QueryComposer;
import org.usf.jquery.web.QueryRequest;
import org.usf.jquery.web.QueryRequestFilter;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@RestController
@RequiredArgsConstructor
public class JQueryController {

	private final DataSource ds;
//	private final JdbcTemplate template; TODO addArgumentResolvers initiated before H2 without template

	@GetMapping("employees")
	public Map<String, Object> fetchEmployees(
			@QueryRequest(database = "demo",view = "employee", defaultColumns = "id,last_name,name,start,photo,notes") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("customers")
	public Map<String, Object> fetchCustomers(
			@QueryRequest(database = "demo",view = "customer", defaultColumns = "id,customer,contact,address,city,postal_code,country") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("shippers")
	public Map<String, Object> fetchShippers(
			@QueryRequest(database = "demo",view = "shipper", defaultColumns = "id,name,phone") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("categories")
	public Map<String, Object> fetchCategories(
			@QueryRequest(database = "demo",view = "category", defaultColumns = "id,name,description") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("suppliers")
	public Map<String, Object> fetchSuppliers(
			@QueryRequest(database = "demo",view = "supplier", defaultColumns = "id,name,contact,address,city,postal_code,country,phone") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("orders")
	public Map<String, Object> fetchOrders(
			@QueryRequest(database = "demo",view = "order", defaultColumns = "id,start,customer_id,employee_id,shipper_id") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("products")
	public Map<String, Object> fetchProducts(
			@QueryRequest(database = "demo",view = "product", defaultColumns = "id,name,supplier_id,category_id,price,unit") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("details")
	public Map<String, Object> fetchOrderDetails(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
			@QueryRequest(database = "demo",view = "order_detail", defaultColumns = "id,order_id,product_id,quantity") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	// RequestQueryParamWithCheck
	@GetMapping("products/test")
	public Map<String, Object> fetchProductsWithCheck(
			@QueryRequestFilter(database = "demo",view = "product", column = "id,name,price",filters= {"price=10,20,30,40,50"},order="price") QueryComposer query) {
		return usingSpringJdbc(query);
	}
	
	@GetMapping("customers/test")
	public Map<String, Object> fetchCustomersWithCheck(
			@QueryRequestFilter(database = "demo",view = "customer", column = "id,customer,country", order = "country.desc", limit = 5, offset = 5,filters={"=country.notNull"}) QueryComposer query) {
		return usingSpringJdbc(query);
	}
	
	@GetMapping("customers/distinct/test")
	public Map<String, Object> fetchCustomersDistinctWithCheck(
			@QueryRequestFilter(database = "demo", view = "customer", column = "id,customer,country", distinct = true, order = "country.desc", limit = 5, offset = 5) QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("orders/distinct/test")
	public Map<String, Object> fetchOrdersWithCheck(
			@QueryRequestFilter(database = "demo",view = "order", column = "id,start,customer_id,employee_id,shipper_id", distinct = true, join = "innercustomer", limit = 5) QueryComposer query) {
		return usingSpringJdbc(query);
	}
	
	@GetMapping("orders/test")
	public Map<String, Object> fetchDistinctOrdersWithCheck(
			@QueryRequestFilter(database = "demo",view = "order", column = "id,start,customer_id,employee_id,shipper_id", join = "innercustomer", limit = 5) QueryComposer query) {
		return usingSpringJdbc(query);
	}
//	private ResponseEntity<Map<String, Object>> usingSpringJdbc(QueryComposer req) {
//		Map<String, Object> result = new HashMap<>();
//		try {			
//			var query = req.build();
//			var sqlQuery = query.getQuery();
//			var queryResult = exec(req);
//			result.put("query", sqlQuery);
//			result.put("result", queryResult);
//			return ResponseEntity.ok(result);
//		} catch (Exception e) {
//			  // Catch it here and return JSON manually
//	        result.put("status", "error");
//	        result.put("message", e.getMessage());
//	        result.put("errorType", e.getClass().getSimpleName());
//
//	        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(result);
//
//		}
//	}
	private Map<String, Object> usingSpringJdbc(QueryComposer req) {
		Map<String, Object> result = new HashMap<>();
		try {			
			var query = req.compose(null, false);
			var sqlQuery = query.toString();
			var queryResult = exec(req);
			result.put("query", sqlQuery);
			result.put("result", queryResult);
		} catch (Exception e) {
			result.put("test_error", e.getMessage());
//			log.error("error exec query : ", e);
		}
		return result;
	}
	
	private Object exec(QueryComposer request)  {
		try {
			return request.compose().execute(ds);
		}
		catch (Exception e) {
			throw new RuntimeException(e); //TODO custom exception
		}
	}

}
