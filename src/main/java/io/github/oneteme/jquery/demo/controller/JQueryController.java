package io.github.oneteme.jquery.demo.controller;

import java.util.Map;

import javax.sql.DataSource;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.usf.jquery.core.Query;
import org.usf.jquery.core.QueryComposer;
import org.usf.jquery.web.RequestQueryParam;

import lombok.RequiredArgsConstructor;

@RestController
@RequiredArgsConstructor
public class JQueryController {

	private final DataSource ds;
//	private final JdbcTemplate template; TODO addArgumentResolvers initiated before H2 without template

	@GetMapping("employees")
	public Map<String, Object> fetchEmployees(
			@RequestQueryParam(database = "demo",view = "employee", defaultColumns = "id,last_name,name,start,photo,notes") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("customers")
	public Map<String, Object> fetchCustomers(
			@RequestQueryParam(database = "demo",view = "customer", defaultColumns = "id,customer,contact,address,city,postal_code,country") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("shippers")
	public Map<String, Object> fetchShippers(
			@RequestQueryParam(database = "demo",view = "shipper", defaultColumns = "id,name,phone") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("categories")
	public Map<String, Object> fetchCategories(
			@RequestQueryParam(database = "demo",view = "category", defaultColumns = "id,name,description") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("suppliers")
	public Map<String, Object> fetchSuppliers(
			@RequestQueryParam(database = "demo",view = "supplier", defaultColumns = "id,name,contact,address,city,postal_code,country,phone") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("orders")
	public Map<String, Object> fetchOrders(
			@RequestQueryParam(database = "demo",view = "order", defaultColumns = "id,start,customer_id,employee_id,shipper_id") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("products")
	public Map<String, Object> fetchProducts(
			@RequestQueryParam(database = "demo",view = "product", defaultColumns = "id,name,supplier_id,category_id,price,unit") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("details")
	public Map<String, Object> fetchOrderDetails(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
			@RequestQueryParam(database = "demo",view = "order_detail", defaultColumns = "id,order_id,product_id,quantity") QueryComposer query) {
		return usingSpringJdbc(query);
	}

	private Map<String, Object> usingSpringJdbc(QueryComposer req) {
		var query = req.compose(null, false);
		var sqlQuery = query.getSql();
		var queryResult = exec(query);
		return Map.of("query", sqlQuery, "result", queryResult);
	}
	
	private Object exec(Query request)  {
		try {
			return request.execute(ds);
		}
		catch (Exception e) {
			throw new RuntimeException(e); //TODO custom exception
		}
	}

}
