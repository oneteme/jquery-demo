package io.github.oneteme.jquery.demo.controller;

import java.util.HashMap;
import java.util.Map;

import javax.sql.DataSource;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.usf.jquery.core.QueryBuilder;
import org.usf.jquery.web.RequestQueryParam;

import lombok.RequiredArgsConstructor;

@RestController
@RequiredArgsConstructor
public class JQueryController {

	private final DataSource ds;
//	private final JdbcTemplate template; TODO addArgumentResolvers initiated before H2 without template

	@GetMapping("employees")
	public Map<String, Object> fetchEmployees(
			@RequestQueryParam(database = "demo",view = "employee", defaultColumns = "id,last_name,name,start,photo,notes") QueryBuilder query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("customers")
	public Map<String, Object> fetchCustomers(
			@RequestQueryParam(database = "demo",view = "customer", defaultColumns = "id,customer,contact,address,city,postal_code,country") QueryBuilder query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("shippers")
	public Map<String, Object> fetchShippers(
			@RequestQueryParam(database = "demo",view = "shipper", defaultColumns = "id,name,phone") QueryBuilder query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("categories")
	public Map<String, Object> fetchCategories(
			@RequestQueryParam(database = "demo",view = "category", defaultColumns = "id,name,description") QueryBuilder query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("suppliers")
	public Map<String, Object> fetchSuppliers(
			@RequestQueryParam(database = "demo",view = "supplier", defaultColumns = "id,name,contact,address,city,postal_code,country,phone") QueryBuilder query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("orders")
	public Map<String, Object> fetchOrders(
			@RequestQueryParam(database = "demo",view = "order", defaultColumns = "id,start,customer_id,employee_id,shipper_id") QueryBuilder query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("products")
	public Map<String, Object> fetchProducts(
			@RequestQueryParam(database = "demo",view = "product", defaultColumns = "id,name,supplier_id,category_id,price,unit") QueryBuilder query) {
		return usingSpringJdbc(query);
	}

	@GetMapping("details")
	public Map<String, Object> fetchOrderDetails(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
			@RequestQueryParam(database = "demo",view = "order_detail", defaultColumns = "id,order_id,product_id,quantity") QueryBuilder query) {
		return usingSpringJdbc(query);
	}

//	private ResponseEntity<Map<String, Object>> usingSpringJdbc(QueryBuilder req) {
//		Map<String, Object> result = new HashMap<>();
//		try {			
//			var query = req.build();
//			var sqlQuery = query.getQuery();
//			var queryResult = exec(req);
//			result.put("query", sqlQuery);
//			result.put("result", queryResult);
//			return ResponseEntity.ok(result);
//		} catch (Exception e) {
//			  // Catch it here and return JSON manually
//	        result.put("status", "error");
//	        result.put("message", e.getMessage());
//	        result.put("errorType", e.getClass().getSimpleName());
//
//	        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(result);
//
//		}
//	}
	private Map<String, Object> usingSpringJdbc(QueryBuilder req) {
		Map<String, Object> result = new HashMap<>();
		try {			
			var query = req.build();
			var sqlQuery = query.getQuery();
			var queryResult = exec(req);
			result.put("query", sqlQuery);
			result.put("result", queryResult);
		} catch (Exception e) {
			result.put("test_error", e.getMessage());
		}
		return result;
	}
	
	private Object exec(QueryBuilder request)  {
		try {
			return request.build().execute(ds);
		}
		catch (Exception e) {
			throw new RuntimeException(e); //TODO custom exception
		}
	}

}
